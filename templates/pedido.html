<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8">
    <title>Doces do Rabudinho - Fazer Pedido</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    
    <script>
        let categoriaSelecionada = null;
        let selecaoAtual = {}; 
        let carrinho = []; 

        function abrirCarrinho() { document.getElementById("modal-carrinho").style.display = "block"; }
        function fecharCarrinho() { document.getElementById("modal-carrinho").style.display = "none"; }
        
        function exibirNotificacao(mensagem) {
            const toast = document.getElementById("toast-notification");
            toast.innerText = mensagem;
            toast.className = "mostrar";
            setTimeout(function(){ toast.className = toast.className.replace("mostrar", ""); }, 2000);
        }

        function selecionarCategoria(card, categoriaNome) {
            document.querySelectorAll('.opcao-tamanho').forEach(c => c.classList.remove('selecionado'));
            card.classList.add('selecionado');
            categoriaSelecionada = categoriaNome;
            document.getElementById("secao-sabores").style.display = "block";
            const todosProdutos = document.querySelectorAll('.card-doce');
            todosProdutos.forEach(produto => {
                const cat = produto.getAttribute('data-categoria');
                if (cat === categoriaNome) { produto.style.display = "block"; } 
                else { produto.style.display = "none"; }
            });
            limparSelecao();
            document.getElementById("secao-sabores").scrollIntoView({ behavior: "smooth" });
        }

        function toggleProduto(card, nome, preco) {
            const estaSelecionado = card.classList.contains('selecionado');
            if (estaSelecionado) {
                card.classList.remove('selecionado');
                delete selecaoAtual[nome];
                const spanQtd = document.getElementById(`qtd-${nome.replace(/\s+/g, '-')}`);
                if (spanQtd) spanQtd.innerText = "0";
            } else {
                card.classList.add('selecionado');
                selecaoAtual[nome] = { qtd: 1, preco: parseFloat(preco) };
                const spanQtd = document.getElementById(`qtd-${nome.replace(/\s+/g, '-')}`);
                if (spanQtd) spanQtd.innerText = "1";
            }
            validarBotaoAdicionar();
        }

        function alterarQtd(event, nome, preco, delta) {
            event.stopPropagation(); 
            if (!selecaoAtual[nome]) selecaoAtual[nome] = { qtd: 0, preco: parseFloat(preco) };
            let novaQtd = selecaoAtual[nome].qtd + delta;
            if (novaQtd < 1) {
                const card = document.getElementById(`card-${nome.replace(/\s+/g, '-')}`);
                if (card) toggleProduto(card, nome, preco);
                return;
            }
            selecaoAtual[nome].qtd = novaQtd;
            const spanQtd = document.getElementById(`qtd-${nome.replace(/\s+/g, '-')}`);
            if (spanQtd) spanQtd.innerText = novaQtd;
            validarBotaoAdicionar();
        }

        function adicionarAoCarrinho() {
            let itensParaAdicionar = [];
            for (let [nome, dados] of Object.entries(selecaoAtual)) {
                itensParaAdicionar.push({ nome: nome, qtd: dados.qtd, preco: dados.preco });
            }
            carrinho.push({ id: Date.now(), categoria: categoriaSelecionada, itens: itensParaAdicionar });
            atualizarVisualCarrinho(); 
            limparSelecao();
            document.querySelectorAll('.opcao-tamanho').forEach(c => c.classList.remove('selecionado'));
            document.getElementById("secao-sabores").style.display = "none";
            categoriaSelecionada = null;
            exibirNotificacao("Item adicionado ao carrinho! ðŸ›’");
        }

        function limparSelecao() {
            selecaoAtual = {};
            document.querySelectorAll('.card-doce').forEach(c => c.classList.remove('selecionado'));
            document.querySelectorAll('.contador-numero').forEach(s => s.innerText = "0");
            validarBotaoAdicionar();
        }

        function validarBotaoAdicionar() {
            const btn = document.getElementById("botao-adicionar");
            const msg = document.getElementById("mensagem-limite");
            let totalItens = 0;
            let valorTotal = 0;
            for (let dados of Object.values(selecaoAtual)) {
                totalItens += dados.qtd;
                valorTotal += (dados.qtd * dados.preco);
            }
            if (categoriaSelecionada && totalItens > 0) {
                btn.disabled = false;
                btn.innerText = `Adicionar (R$ ${valorTotal.toFixed(2)})`;
                msg.innerHTML = `${totalItens} item(ns) selecionados`;
            } else {
                btn.disabled = true;
                btn.innerText = "Selecione os produtos";
                msg.innerText = "";
            }
        }

        function atualizarVisualCarrinho() {
            const lista = document.getElementById("lista-itens");
            const totalSpan = document.getElementById("total-valor");
            const btnFlutuante = document.getElementById("btn-flutuante");
            const badge = document.getElementById("badge-contador");
            lista.innerHTML = "";
            let totalGeral = 0;
            if (carrinho.length === 0) {
                btnFlutuante.style.display = "none"; 
                fecharCarrinho();
                return;
            }
            btnFlutuante.style.display = "flex";
            carrinho.forEach(lote => {
                let htmlItens = "";
                lote.itens.forEach(item => {
                    let sub = item.qtd * item.preco;
                    totalGeral += sub;
                    htmlItens += `<div>${item.qtd}x ${item.nome} <small>(R$ ${item.preco.toFixed(2)})</small></div>`;
                });
                const li = document.createElement("li");
                li.className = "item-carrinho";
                li.innerHTML = `
                    <div class="info"><strong>${lote.categoria}</strong>${htmlItens}</div>
                    <div class="preco"><button onclick="removerDoCarrinho(${lote.id})" class="btn-remover">X</button></div>
                `;
                lista.appendChild(li);
            });
            totalSpan.innerText = totalGeral.toFixed(2).replace('.', ',');
            badge.innerText = carrinho.length;
        }

        function removerDoCarrinho(id) {
            carrinho = carrinho.filter(x => x.id !== id);
            atualizarVisualCarrinho();
        }

        function finalizarCompra() {
            fetch('/finalizar_pedido', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ carrinho: carrinho })
            }).then(r => r.json()).then(data => document.body.innerHTML = data.html);
        }

        window.onclick = function(event) {
            const modal = document.getElementById("modal-carrinho");
            if (event.target == modal) fecharCarrinho();
        }
    </script>
</head>
<body>

    <header class="header-simples">
        <nav>
            <img src="{{ url_for('static', filename='img/rabudinho1.png') }}" alt="Logo Burrinho" class="logo-nav">
            
            <a href="/">InÃ­cio</a>
            <a href="/pedido">Fazer Pedido</a>
            <a href="/cadastro">Cadastro</a>
            <a href="/login">Login</a>
            <a href="/contato">Contato</a>
            <a href="/feedback">Feedback</a>
        </nav>
    </header>

<main>

    <h2 style="text-transform: uppercase;">COM QUE VAMOS ADOÃ‡AR SEU DIA HOJE?</h2>
    
    <div class="grid-tamanhos">
        <div class="opcao-tamanho" onclick="selecionarCategoria(this, 'Bolo de Pote')">
            <h3>Bolo de Pote</h3>
            <p>Diversos sabores</p>
        </div>
        <div class="opcao-tamanho" onclick="selecionarCategoria(this, 'Empada')">
            <h3>Empada</h3>
            <p>Salgados deliciosos</p>
        </div>
        <div class="opcao-tamanho" onclick="selecionarCategoria(this, 'Trufa')">
            <h3>Trufa</h3>
            <p>Chocolates finos</p>
        </div>
    </div>

    <div id="secao-sabores" style="display: none; margin-top: 50px;">
        <h2>Selecione os Produtos</h2>
        <p class="mensagem" id="mensagem-limite"></p>

        <div class="grid-cardapio">
            {% for doce in produtos %}
            <div class="card-doce" 
                 id="card-{{ doce.nome|replace(' ', '-') }}"
                 data-categoria="{{ doce.categoria }}"
                 onclick="toggleProduto(this, '{{ doce.nome }}', '{{ doce.preco }}')">
                
                <img src="{{ url_for('static', filename='img/' + doce.img_file) }}" alt="{{ doce.nome }}">
                <h3>{{ doce.nome }}</h3>
                <p class="preco-destaque">R$ {{ "%.2f"|format(doce.preco) }}</p>
                <p>{{ doce.descricao }}</p>

                <div class="controle-qtd">
                    <button class="btn-qtd" onclick="alterarQtd(event, '{{ doce.nome }}', '{{ doce.preco }}', -1)">-</button>
                    <span class="contador-numero" id="qtd-{{ doce.nome|replace(' ', '-') }}">0</span>
                    <button class="btn-qtd" onclick="alterarQtd(event, '{{ doce.nome }}', '{{ doce.preco }}', 1)">+</button>
                </div>
            </div>
            {% endfor %}
        </div>

        <button type="button" id="botao-adicionar" class="botao" disabled onclick="adicionarAoCarrinho()">
            Adicionar ao Carrinho
        </button>
    </div>

    <div id="toast-notification">Item adicionado ao carrinho!</div>

    <div id="btn-flutuante" class="fab-carrinho" onclick="abrirCarrinho()" style="display: none;">
        ðŸ›’
        <span id="badge-contador" class="badge">0</span>
    </div>

    <div id="modal-carrinho" class="modal-fundo">
        <div class="modal-conteudo">
            <span class="fechar-modal" onclick="fecharCarrinho()">&times;</span>
            <h2>ðŸ›’ Seu Carrinho</h2>
            <ul id="lista-itens"></ul>
            <div class="total-carrinho">Total: R$ <span id="total-valor">0,00</span></div>
            <button id="btn-finalizar-compra" class="botao" onclick="finalizarCompra()">âœ… FECHAR PEDIDO</button>
            <button class="botao-secundario" onclick="fecharCarrinho()">Continuar Comprando</button>
        </div>
    </div>

</main>
</body>
</html>